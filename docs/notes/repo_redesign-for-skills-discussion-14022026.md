Это критически важный этап. Если мы начнем писать Skills поверх "каши" в репозитории, мы утонем в зависимостях. Нам нужно подготовить **"Чистый Стол"** (Clean Slate).

Вот пошаговый план **Инфраструктурного Рефакторинга**, который нужно выполнить **до** написания первого `SKILL.md`.

---

### Этап 0: Административная Гигиена (Git & Repo)

*Цель: Зафиксировать новое имя и правила игры.*

1. **Rename Repository:** Переименуй репозиторий в GitHub в `yet-another-agents-memory` (или `yaam`).
2. **Clean Branches:**
* Удали старые ветки `dev-mas`, `dev-tests` (если они смержены или неактуальны).
* Создай ветку `dev` от текущего `main`.
* В настройках GitHub сделай `dev` веткой по умолчанию (Default Branch).


3. **Lock Main:** В настройках GitHub (Branch Protection Rules) для `main`:
* "Require pull request before merging".
* "Require status checks to pass" (пока пусто, но галочку поставь).
* "Lock branch" (опционально, чтобы даже админы не писали напрямую).



---

### Этап 1: Физическая Реструктуризация (File System)

*Цель: Создать структуру монорепозитория, где Core и Agents живут отдельно.*

В ветке `dev` создай новую структуру папок. Не бойся временно "сломать" импорты, мы починим их на Этапе 2.

1. **Создай скелет:**
```text
mkdir -p core/src/yaam_core
mkdir -p skills/_template
mkdir -p agents/src
mkdir -p infrastructure/docker

```


2. **Изоляция зависимостей (Split Pyproject):**
* Перемести текущий `pyproject.toml` в `core/`. Отредактируй его: оставь только системные библиотеки (`redis`, `pydantic`, `neo4j`, `qdrant-client`). Убери `langchain`, `openai` и все агентское.
* Создай новый `pyproject.toml` в `agents/`. Там будут `langgraph`, `langchain`, `openai` и... зависимость от `yaam-core` (как path dependency: `yaam-core = {path = "../core", develop = true}`).



---

### Этап 2: Миграция "Механизма" (Core Migration)

*Цель: Перенести "Драйверы" и "Жизненный цикл" в Core и заморозить их.*

1. **Перенос Коннекторов:**
* Найди свой текущий код работы с Redis, Postgres, Neo4j, Qdrant.
* Перемести файлы в `core/src/yaam_core/connectors/`.
* **Рефакторинг:** Убери из них любую бизнес-логику (промпты, сложные цепочки рассуждений). Оставь только методы "исполнить запрос", "вставить вектор", "прочитать лог".


2. **Перенос Движков:**
* Перемести `PromotionEngine` и `DistillationEngine` в `core/src/yaam_core/engines/`.
* Убедись, что они работают с `connectors`, а не ходят в БД напрямую.


3. **Чистка:** Удали старые папки `src/memory`, `src/storage` из корня (так как код уехал в `core`).

---

### Этап 3: Создание Skill Runtime (Новый код)

*Цель: Научить Core загружать навыки, даже если самих навыков еще нет.*

Прежде чем писать скиллы, нам нужен код, который умеет их читать. Напиши в `core/src/yaam_core/runtime/`:

1. **`skill_registry.py`:** Класс, который:
* Принимает путь к папке `skills/`.
* Сканирует подпапки.
* Читает `SKILL.md` (парсит Frontmatter/Metadata).
* Валидирует структуру (есть ли папка `tools`, есть ли `references`).


2. **`skill_loader.py`:** Метод `load_skill(skill_name)`, который возвращает объект `Skill` (с текстом инструкции и путями к инструментам).

*На этом этапе Core — это уже не просто набор скриптов, а библиотека, которую можно импортировать.*

---

### Этап 4: Настройка CI (Safety Net)

*Цель: Гарантировать, что Core собирается и проходит тесты.*

1. Создай `.github/workflows/ci.yml`.
2. Настрой два джоба:
* **Core-CI:** Заходит в папку `core`, ставит зависимости, гоняет линтеры (`ruff`) и тесты (`pytest`).
* **Agents-CI:** Заходит в `agents`, ставит зависимости (включая Core), проверяет, что агенты видят Core.



---

### Итоговый чек-лист "Definition of Ready" для написания Skills:

Ты можешь приступать к написанию Skills только когда:

1. [ ] Репозиторий имеет структуру `core/`, `skills/`, `agents/`.
2. [ ] В `core/` лежат "глупые" коннекторы к БД (без промптов).
3. [ ] Написан класс `SkillRegistry`, который не падает при запуске и видит пустую папку `skills/`.
4. [ ] Проходит CI pipeline в ветке `dev`.