# Lessons Learned Register

This register captures recurring issues surfaced during development and the mitigations that resolve them. Entries should be concise, structured, and updated immediately after an incident is resolved.

## Usage Guidelines
- Document only project-specific incidents that produced unexpected failures or workflow friction.
- Prefer objective wording; avoid speculation unless clearly marked as a hypothesis.
- Include enough context (environment, command, files) so another engineer can reproduce or validate the scenario.
- Link to supporting artifacts such as logs, pull requests, or chat transcripts when available.

## Entry Template
Use the following table format for all new entries. Update the `Status` column as mitigations are adopted or superseded.

| Date       | Incident ID           | Environment        | Symptom                                                                 | Root Cause                                                                                   | Mitigation                                                                                                    | Status   | References |
|------------|-----------------------|--------------------|-------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------|----------|------------|
| YYYY-MM-DD | LL-YYYYMMDD-XX        | Host + OS details | Brief error description (command/test/etc.)                             | Concise explanation of why the issue occurred                                                | Specific steps, scripts, or instruction updates that prevent recurrence                                      | Active   | Links      |

## Entries

| Date       | Incident ID            | Environment                        | Symptom                                                                                               | Root Cause                                                                                                    | Mitigation                                                                                                                                                   | Status   | References |
|------------|------------------------|------------------------------------|-------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|------------|
| 2026-02-10 | LL-20260210-01         | Local macOS + repo docs            | Conflicting instructions on whether to use absolute or relative paths in change summaries.          | App-level formatting required absolute paths, while repository protocol required logical (relative) paths.    | Escalate to the user for a decision and document the chosen path convention for the session before applying edits.                                         | Adopted  | Session log 2026-02-10 |
| 2026-02-10 | LL-20260210-02         | Local macOS + pytest               | Full `pytest tests/ -v` run failed/errored on integration/real-provider tests requiring live services and credentials. | Integration + llm_real tests depend on external services/keys not available in local runner. | Use marker scope `-m "not integration and not llm_real"` for unit runs; reserve full suite for environments with all services configured. | Adopted  | Session log 2026-02-10 |
| 2026-02-10 | LL-20260210-03         | Local macOS + make                 | `make build` failed with “No rule to make target `build`.”                                              | Repository Makefile does not define a `build` target.                                                           | Skip `make build` until a build target is defined; document alternative build steps if/when specified.                                              | Active   | Session log 2026-02-10 |
| 2026-02-10 | LL-20260210-04         | Local macOS + Docker buildx        | `make build` failed with "failed to update builder last activity time" (operation not permitted).     | Docker buildx activity directory was not writable in the execution environment.                                | Run `make build` where Docker Desktop/buildx has permission to write its activity cache; consider resetting buildx if permissions are corrupted. | Active   | Session log 2026-02-10 |
| 2026-02-10 | LL-20260210-05         | Local macOS + smoke test           | Smoke test HTTP calls to `localhost:8080` failed with "Operation not permitted" from urllib.         | Execution environment blocks outbound socket connections to localhost from the runner.                         | Run smoke tests from the host terminal (outside the runner sandbox) where localhost sockets are permitted. | Active   | Session log 2026-02-10 |
| 2026-02-05 | LL-20260205-03         | Local macOS + shell tools          | `rg` command not found when searching for benchmark visibility references.                           | Ripgrep is not installed or not on PATH in the local environment.                                             | Use `grep -R` fallback for repository-wide searches when `rg` is unavailable.                                                                               | Adopted  | Session log 2026-02-05 |
| 2026-02-05 | LL-20260205-04         | Local macOS + pytest               | Long-running `pytest` invocation produced no output through the command runner; follow-up diagnostics overwrote `/tmp/copilot.out`. | The command runner buffered output until completion; reusing `/tmp/copilot.out` for diagnostic commands overwrote the test output. | Avoid issuing additional commands that write to `/tmp/copilot.out` while a long-running command is still executing; use a separate temp file for diagnostics or wait for completion. | Active   | Session log 2026-02-05 |
| 2026-02-05 | LL-20260205-01         | Remote Ubuntu VM + mypy (benchmarks) | Benchmark mypy cleanup required widespread edits to resolve Optional handling, interface typing, and score arithmetic inconsistencies. | The benchmark code relied on implicit Any flows, mixed int/float scoring, and ad hoc interfaces without Protocols, which became brittle under strict mypy settings. | Enforce explicit Optional guards and casts in runner/reporting paths, standardize score types to float, add Protocol-based interfaces, and add missing package initializers for reporting/model modules. | Adopted  | [docs/reports/goodai_ltm_benchmark_reports_version-0.9_upto10feb2026.md](docs/reports/goodai_ltm_benchmark_reports_version-0.9_upto10feb2026.md), [docs/plan/phase2_3_engineering_plans_version-0.9.md](docs/plan/phase2_3_engineering_plans_version-0.9.md) |
| 2026-02-05 | LL-20260205-02         | Local macOS + pip                   | `pip install -r requirements.txt` failed with "No matching distribution found for arize-phoenix>=4.0.0" after repeated connection errors. | Network-restricted environment prevented pip from reaching the package index for `arize-phoenix`, so resolution failed despite other deps being installed. | Proceed using the existing virtualenv when deps are already present; if fresh install is required, run pip with network access or pre-seed wheels in a local cache. | Active   | Session log 2026-02-05 |
| 2026-02-05 | LL-20260205-03         | Local macOS + pytest                | Test collection failed with `ModuleNotFoundError` for `langgraph` and `fastapi`. | Required runtime dependencies are missing from the current virtualenv (likely due to pip install failure or missing packages in requirements). | Install missing packages with network access or ensure they are included in `requirements.txt` before running full test suite. | Active   | Session log 2026-02-05 |
| 2026-02-07 | LL-20260207-01         | Remote Ubuntu VM + pytest/mypy      | Test collection failed with `AssertionError: Unreachable` during import of storage adapters. | `raise AssertionError("Unreachable")` statements intended as mypy return guards were placed at class scope (wrong indentation), executing at import time. | Keep mypy guards inside method bodies (post-`async with`) or refactor to explicit returns; never leave assertion guards at class scope. | Adopted | [docs/reports/preliminary_readiness_checks_version-0.7_upto10feb2026.md](docs/reports/preliminary_readiness_checks_version-0.7_upto10feb2026.md) |
| 2026-02-04 | LL-20260204-02         | Remote Ubuntu VM + pre-commit       | Batch commits repeatedly pulled in test-generated logs and report artifacts, obscuring actual code changes. | Test execution emits logs and JSON reports in tracked directories, leading to incidental diffs during staged commits. | Add a log ignore policy for runtime artifacts (gitignore) and document rationale in [logs/README.md](logs/README.md); explicitly revert test artifacts before staging batch commits. | Adopted  | [docs/reports/mypy-remediation-batch-completion-2026-02-04.md](docs/reports/mypy-remediation-batch-completion-2026-02-04.md) |
| 2026-01-03 | LL-20260103-01         | Remote Ubuntu VM + Qdrant          | Test `test_l2_to_l3_consolidation_with_episode_clustering` fails with "No episodes found in Qdrant" despite successful store (status=COMPLETED). Test passed after collection recreation but failed on subsequent runs with accumulated data. | Qdrant `search()` is **vector-similarity-first**: finds N most similar vectors, THEN applies filters. Test used dummy query vector `[0.1]*768` which has ~0 similarity to real Gemini embeddings. Our session's point wasn't in top-10 by similarity, so filter returned nothing. Empty collection worked because our point was the only option. | 1. Added `scroll()` method to `QdrantAdapter` for pure filter-based retrieval (no vector similarity). 2. Changed test to use `scroll()` instead of `search()` for session-based queries. 3. Use `search()` only for semantic similarity queries; use `scroll()` for metadata-based retrieval. | Adopted  | [docs/reports/qdrant-scroll-vs-search-debugging-2026-01-03.md](reports/qdrant-scroll-vs-search-debugging-2026-01-03.md) |
| 2025-12-29 | LL-20251229-01         | Remote Ubuntu VM + Gemini API      | "Unterminated string starting at: line 7 column 9 (char 505)" - JSON parsing failures in FactExtractor/TopicSegmenter with harmony-format models | LLM concatenated system+user prompts without structured output enforcement. Groq's openai/gpt-oss-120b outputs harmony format (analysis+final channels) incompatible with simple JSON.loads(). No model-to-provider routing caused Gemini models to be sent to Groq provider. | 1. Use native `types.Schema` structured output with `response_mime_type="application/json"`. 2. Separate `system_instruction` parameter. 3. Add `MODEL_ROUTING` map in LLMClient to route models to correct providers. 4. Switch to gemini-3-flash-preview as primary model (ADR-006). Created schema definitions in `src/memory/schemas/` with FACT_EXTRACTION_SCHEMA and TOPIC_SEGMENTATION_SCHEMA. | Adopted  | DEVLOG 2025-12-29, examples/gemini_structured_output_test.md, tests/test_fact_extraction_with_real_data.py |
| 2025-11-15 | LL-20251115-01         | Local macOS checkout (`dev` branch) | `run_in_terminal` reported "no output" after commands with `> /tmp/... && cat /tmp/...` chaining. | Main command exited non-zero (missing binary), so the `&& cat` step never executed, hiding captured stderr. | Always capture output to `/tmp/*.out` but follow with `; cat /tmp/*.out` (or separate `cat` command) so logs surface even when the primary command fails. Update instructions to note this pattern. | Adopted  | Session log 2025-11-15 |
| 2026-02-04 | LL-20260204-01         | Remote Ubuntu VM + mypy 1.8+ | Pre-commit mypy check fails with 119 type errors. Mypy crashes with "Cannot find module for google" when processing google.genai imports. | Multiple root causes: (1) Redis asyncio returns `Awaitable[T] | T` unions incompatible with await. (2) Dict invariance when passing adapter subclass dicts. (3) Stats dict values become `object` type preventing arithmetic. (4) Google GenAI SDK uses namespace packages incompatible with mypy's module resolution. (5) Tier/adapter API signature mismatches. | 1. Use explicit type casts for Redis returns: `int(result)`, `bool(result)`. 2. Use `Mapping[str, T]` instead of `dict[str, T]` for covariant collections. 3. Annotate stats dicts: `dict[str, int]` or use helper `inc()` function. 4. Use `importlib.import_module()` for google.genai imports. 5. Add `--namespace-packages` to mypy invocation. 6. Added "Mypy Type Safety Guidelines" section to `.github/instructions/source.instructions.md`. | Active | [docs/plan/phase2_3_engineering_plans_version-0.9.md](plan/phase2_3_engineering_plans_version-0.9.md) |
